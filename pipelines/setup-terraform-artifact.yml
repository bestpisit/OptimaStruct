variables:
- group: terraform
- name: $projectname
  value: '$(projectname)'
- name: $environment
  value: '$(environment)'
- name: $saterraform
  value: '$(saterraform)'

trigger:
  branches:
    include:
      - vol2
  paths:
    include:
      - terraform/*

resources:
  repositories:
  - repository: self
    type: git
    ref: refs/heads/main

jobs:
  - job: build
    pool:
      vmImage: 'windows-latest'
    displayName: 'Setup terraform artifact'
    workspace:
      clean: all
    steps:
      - checkout: self
        clean: true
        fetchTags: false
      - task: PowerShell@2
        displayName: Setup Variables
        inputs:
          filePath: 'scripts\setup\setup-variable.ps1'
      - task: AzureCLI@2
        displayName: 'Setup Terraform'
        inputs:
          azureSubscription: 'sc-terraform'
          scriptType: ps
          scriptLocation: scriptPath
          scriptPath: 'scripts\setup\setup-terraform.ps1'
          powerShellErrorActionPreference: stop
      - task: replacetokens@5
        displayName: Setup config for terraform
        inputs:
          rootDirectory: terraform
          targetFiles: '/*.tf'
          tokenPattern: rm
      - task: PublishPipelineArtifact@1
        displayName: Publish terraform Artifact
        inputs:
          path: terraform
          artifactName: terraform